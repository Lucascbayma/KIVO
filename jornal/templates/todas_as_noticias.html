{% extends 'base.html' %}
{% load static %}

{% block title %}Todas as Notícias - Portal JC{% endblock %}

{% block content %}
    <link rel="stylesheet" href="{% static 'jornal/css/todas-noticias.css' %}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <form method="get" class="filtros-container" id="form-filtros">
        
        <div class="campo-busca">
            <i class="bi bi-search"></i>
            <input id="campo-busca-input" type="text" name="q" value="{{ busca|default:'' }}" placeholder="Buscar">
        </div>

        <div id="caixa-sugestoes" class="sugestoes hidden"></div>

        <div class="item-filtro">
            <i class="bi bi-funnel"></i>
            <span>Filtrar</span>
        </div>

        <div class="item-ordenar">
            <i class="bi bi-sort-down"></i>
            <span class="label-ordenar">Ordenar por:</span>
            
            <div class="custom-dropdown" id="dropdown-ordenar">
                <div class="dropdown-selected" id="dropdown-text">
                    {% if ordenacao == "mais_antigas" %}Mais antigas
                    {% elif ordenacao == "titulo_az" %}Título A–Z
                    {% elif ordenacao == "titulo_za" %}Título Z–A
                    {% else %}Mais recentes{% endif %}
                </div>
                
                <div class="dropdown-options">
                    <div class="dropdown-item" data-value="mais_recentes">Mais recentes</div>
                    <div class="dropdown-item" data-value="mais_antigas">Mais antigas</div>
                    <div class="dropdown-item" data-value="titulo_az">Título A–Z</div>
                    <div class="dropdown-item" data-value="titulo_za">Título Z–A</div>
                </div>
                
                <input type="hidden" name="ordenar" id="input-ordenar" value="{{ ordenacao|default:'mais_recentes' }}">
            </div>
        </div>

        {% if categoria_nome %}
            <input type="hidden" name="categoria" value="{{ categoria_nome }}">
        {% endif %}
    </form>

    <div class="grid-noticias">
        {% for n in page_obj %}
        <div class="card">
            <div class="media">
                <a href="{% url 'artigo_detalhe' pk=n.pk %}">
                    {% if n.imagem %}
                        <img src="{{ n.imagem.url }}" alt="{{ n.titulo }}">
                    {% else %}
                        <img src="{% static 'jornal/imagens/sem-imagem.png' %}" alt="Sem imagem">
                    {% endif %}
                </a>
            </div>
            <div class="meta">
                <p class="title">{{ n.titulo }}</p>
            </div>
        </div>
        {% empty %}
            <p style="text-align:center; font-family:'Inter'; margin-top:20px;">Não há notícias relacionadas a esse tema.</p>
        {% endfor %}
    </div>

    {% if page_obj.has_other_pages %}
    <div class="pagination" style="text-align:center; margin-top:30px; font-family:'Inter'; margin-bottom: 20px;">
        {% if page_obj.has_previous %}
            <a href="?page={{ page_obj.previous_page_number }}{% if categoria_nome %}&categoria={{ categoria_nome }}{% endif %}{% if busca %}&q={{ busca }}{% endif %}">&laquo; Anterior</a>
        {% endif %}
        
        <span style="margin: 0 10px;">Página {{ page_obj.number }} de {{ page_obj.paginator.num_pages }}</span>
        
        {% if page_obj.has_next %}
            <a href="?page={{ page_obj.next_page_number }}{% if categoria_nome %}&categoria={{ categoria_nome }}{% endif %}{% if busca %}&q={{ busca }}{% endif %}">Próxima &raquo;</a>
        {% endif %}
    </div>
    {% endif %}

{% endblock %}

{% block scripts %}
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const dropdownContainer = document.getElementById('dropdown-ordenar');
            const selected = dropdownContainer.querySelector('.dropdown-selected');
            const optionsList = dropdownContainer.querySelector('.dropdown-options');
            const hiddenInput = document.getElementById('input-ordenar');
            const form = document.getElementById('form-filtros');

            // Abrir/Fechar dropdown
            selected.addEventListener('click', function(e) {
                e.stopPropagation(); 
                optionsList.classList.toggle('show'); 
                dropdownContainer.classList.toggle('active'); 
            });

            // Selecionar Opção
            dropdownContainer.querySelectorAll('.dropdown-item').forEach(item => {
                item.addEventListener('click', function(e) {
                    e.stopPropagation();
                    
                    const value = this.getAttribute('data-value');
                    const text = this.innerText;

                    // Atualiza visual e input
                    selected.innerText = text;
                    hiddenInput.value = value;
                    
                    // Fecha
                    optionsList.classList.remove('show');
                    dropdownContainer.classList.remove('active');

                    // Submete o formulário automaticamente
                    form.submit();
                });
            });

            // Fechar ao clicar fora
            document.addEventListener('click', function() {
                if (optionsList.classList.contains('show')) {
                    optionsList.classList.remove('show');
                    dropdownContainer.classList.remove('active');
                }
            });
        });
    </script>
{% endblock %}