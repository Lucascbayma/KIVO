{% extends 'base.html' %}
{% load static %}

{% block title %}Escolha suas Preferências | Newsletter{% endblock %}

{% block content %}
    <link rel="stylesheet" href="{% static 'jornal/css/newsletter.css' %}">
    <div id="newsletter-main"> 
        
        <section class="section-preferences">
            <h2>1. Escolha suas preferências</h2>

            <div class="newsletter-option" data-topic="essencial-jc">
                <div class="option-icon">
                    <img src="{% static 'jornal/imagens/essencial.png' %}" alt="Ícone Essencial">
                </div>

                <div class="newsletter-option-content">
                    <h3>Essencial JC</h3>
                    <p>Receba todas as newsletters do combo Essencial com as notícias mais importantes de 5 em 5 minutos.</p>
                    <button class="add-button">+ Adicionar</button>
                </div>
            </div>

            <div class="newsletter-option" data-topic="saude-bem-estar">
                <div class="option-icon">
                    <img src="{% static 'jornal/imagens/saude.png' %}" alt="Ícone Saúde">
                </div>
                <div class="newsletter-option-content">
                    <h3>Saúde e Bem-Estar</h3>
                    <p>Às segundas, notícias aprofundadas e relevantes sobre saúde, bem-estar, medicamentos e tratamentos.</p>
                    <button class="add-button">+ Adicionar</button>
                </div>
            </div>
            
            <div class="newsletter-option" data-topic="nas-telas">
                <div class="option-icon">
                    <img src="{% static 'jornal/imagens/telas.png' %}" alt="Ícone Telas">
                </div>
                <div class="newsletter-option-content">
                    <h3>Nas Telas</h3>
                    <p>Às quintas, muita informação sobre séries, estreias de cinema, vida dos atores e análises.</p>
                    <button class="add-button">+ Adicionar</button>
                </div>
            </div>

            <hr class="separator">
        </section>

        <section class="section-finalize">
            <h2>2. Finalize sua inscrição</h2>

            <div id="selected-topics-list"></div>

            <form id="subscribe-form" action="{% url 'jornal:cadastrar_newsletter' %}" method="POST">
                {% csrf_token %}
                
                <div class="form-group">
                    <label for="email">Informe seu e-mail:</label>
                    <input type="email" id="email" name="email" placeholder="Digite seu e-mail aqui" required>
                </div>

                <div class="form-group">
                    <label for="name">Como você quer ser chamado?</label>
                    <input type="text" id="name" name="name" placeholder="É assim que vamos te cumprimentar">
                </div>

                <div class="form-group terms-group">
                    <input type="checkbox" id="terms" name="terms" required>
                    <label for="terms">Aceito os termos de <a href="#" target="_blank">Privacidade</a></label>
                </div>

                <button type="submit" class="subscribe-button-final">Concluir Inscrição</button>
                
                <input type="hidden" id="preferences-input" name="preferences">
            </form>
        </section>

    </div> 

{% endblock %}

{% block scripts %}
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            
            const addButtons = document.querySelectorAll('.add-button');
            const selectedList = document.getElementById('selected-topics-list');
            const preferencesInput = document.getElementById('preferences-input');
            
            let selectedTopics = [];

            function updateHiddenInput() {
                preferencesInput.value = selectedTopics.join(',');
            }

            function addTopic(card) {
                // Busca o H3 dentro do .newsletter-option-content
                const topicName = card.querySelector('h3').innerText.trim();
                const btn = card.querySelector('.add-button');

                if (selectedTopics.includes(topicName)) return;

                selectedTopics.push(topicName);
                updateHiddenInput();

                // Cria o elemento visual de item selecionado
                const itemDiv = document.createElement('div');
                itemDiv.classList.add('selected-item');
                itemDiv.setAttribute('data-topic-name', topicName);
                
                itemDiv.innerHTML = `
                    <span>${topicName}</span>
                    <span class="remove-topic" role="button" title="Remover">
                        <i class="bi bi-trash"></i> Remover
                    </span>
                `;

                selectedList.appendChild(itemDiv);

                // Muda estado do botão
                btn.innerHTML = 'Adicionado';
                btn.style.backgroundColor = '#2ECC71'; // Verde visual rápido
                btn.style.cursor = 'default';
                btn.disabled = true;
            }

            function removeTopic(element) {
                const itemDiv = element.closest('.selected-item');
                const topicName = itemDiv.getAttribute('data-topic-name');

                selectedTopics = selectedTopics.filter(t => t !== topicName);
                updateHiddenInput();

                itemDiv.remove();

                // Reabilita o botão correspondente
                const cards = document.querySelectorAll('.newsletter-option');
                cards.forEach(card => {
                    if (card.querySelector('h3').innerText.trim() === topicName) {
                        const btn = card.querySelector('.add-button');
                        btn.innerHTML = '+ Adicionar';
                        btn.style.backgroundColor = ''; // Volta ao CSS original (vermelho)
                        btn.style.cursor = 'pointer';
                        btn.disabled = false;
                    }
                });
            }

            // Evento de Adicionar
            addButtons.forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.preventDefault();
                    // O card pai é o .newsletter-option (avô do botão agora)
                    const card = this.closest('.newsletter-option');
                    addTopic(card);
                });
            });

            // Evento de Remover (Delegação de evento)
            selectedList.addEventListener('click', function(e) {
                const removeBtn = e.target.closest('.remove-topic');
                if (removeBtn) {
                    removeTopic(removeBtn);
                }
            });
        });
    </script>
{% endblock %}