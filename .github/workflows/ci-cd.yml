name: Django CI/CD - Webhook

on:
  # Dispara a pipeline em pushes para o branch 'main'
  push:
    branches:
      - main
  # Dispara a pipeline em Pull Requests direcionados ao branch 'main'
  pull_request:
    branches:
      - main

jobs:
  # 1. Job de Integração Contínua (CI - Testes)
  ci:
    # O job de CI rodará em um ambiente Ubuntu
    runs-on: ubuntu-latest
    
    # Define o PYTHONPATH para garantir que o Django encontre os módulos do projeto
    env:
      PYTHONPATH: ${{ github.workspace }}
      
    steps:
    # Faz o checkout do código do repositório
    - uses: actions/checkout@v4

    # Instala o git no runner (pode ser necessário dependendo das suas bibliotecas/estrutura)
    - name: Install system dependencies (git)
      run: sudo apt-get update && sudo apt-get install -y git
      
    # Configura o ambiente Python
    - name: Set up Python
      uses: actions/setup-python@v4 
      with:
        # Define a versão do Python (3.10 é a usada no seu exemplo)
        python-version: '3.10'

    # Instala as dependências listadas no requirements.txt
    - name: Install Dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        
    # Executa os testes do Django
    - name: Run Tests
      # Define uma SECRET_KEY temporária apenas para a execução dos testes de CI
      run: |
        export SECRET_KEY='ci-secret-key-para-testes'
        python manage.py test
      
  # 2. Job de Deployment (CD)
  cd:
    # O deployment SÓ rodará se o job 'ci' for concluído com SUCESSO
    needs: ci
    runs-on: ubuntu-latest
    
    # Este estágio apenas dispara o Webhook, que é o código Django no servidor de deploy
    steps:
    - name: Trigger PythonAnywhere Webhook for Deployment
      # O comando curl envia um POST para o endpoint /webhook/github/
      # O domínio é lido do Secret do repositório (PA_WEBAPP_DOMAIN)
      run: |
        curl -X POST \
        -H "Content-Type: application/json" \
        -d '{"ref": "refs/heads/${{ github.ref_name }}"}' \
        https://${{ secrets.PA_WEBAPP_DOMAIN }}/webhook/github/