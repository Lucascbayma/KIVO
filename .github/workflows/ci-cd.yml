name: Django CI/CD - Webhook

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  ci:
    runs-on: ubuntu-latest
    env:
      PYTHONPATH: ${{ github.workspace }}
      
    steps:
    - uses: actions/checkout@v4

    - name: Install system dependencies (git)
      run: sudo apt-get update && sudo apt-get install -y git
      
    - name: Set up Python
      uses: actions/setup-python@v4 
      with:
        python-version: '3.10'

    - name: Install Dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        
    - name: Run Tests
      # AQUI EST√Å A CORRE√á√ÉO M√ÅGICA üëá
      env:
        NEWSDATA_API_KEY: ${{ secrets.NEWSDATA_API_KEY }}
        SECRET_KEY: 'ci-secret-key-para-testes'
      run: |
        python manage.py test
      
  cd:
    needs: ci
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
    - name: Trigger PythonAnywhere Webhook for Deployment
      run: |
        curl -X POST \
        -H "Content-Type: application/json" \
        -d '{"ref": "refs/heads/${{ github.ref_name }}"}' \
        https://${{ secrets.PA_WEBAPP_DOMAIN }}/webhook/github/