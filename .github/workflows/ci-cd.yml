name: Django CI/CD - Webhook

on:
  # Dispara a pipeline quando há código novo na main
  push:
    branches:
      - main
  # Dispara a pipeline para testar Pull Requests (mas não faz deploy)
  pull_request:
    branches:
      - main

jobs:
  # 1. Job de Integração Contínua (Testes)
  ci:
    runs-on: ubuntu-latest
    env:
      PYTHONPATH: ${{ github.workspace }}
      
    steps:
    - uses: actions/checkout@v4

    - name: Install system dependencies (git)
      run: sudo apt-get update && sudo apt-get install -y git
      
    - name: Set up Python
      uses: actions/setup-python@v4 
      with:
        python-version: '3.10'

    - name: Install Dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        
    - name: Run Tests
      run: |
        export SECRET_KEY='ci-secret-key-para-testes'
        python manage.py test
      
  # 2. Job de Deployment (CD)
  cd:
    needs: ci
    runs-on: ubuntu-latest
    # ATUALIZAÇÃO IMPORTANTE:
    # Garante que o deploy só roda se for um PUSH na MAIN.
    # Evita deploys acidentais durante Pull Requests.
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
    - name: Trigger PythonAnywhere Webhook for Deployment
      run: |
        curl -X POST \
        -H "Content-Type: application/json" \
        -d '{"ref": "refs/heads/${{ github.ref_name }}"}' \
        https://${{ secrets.PA_WEBAPP_DOMAIN }}/webhook/github/